PyVN stories are written in `.tgame` files, which are plain text files using a simple markup language combined with the powerful Jinja2 templating engine.

### Passages

A story is divided into **passages**. Each passage is a distinct screen or section of your narrative, starting with `::` followed by the passage name.

```
:: Start
Welcome to my first PyVN game! This is the starting passage.

:: ForestPath
You are on a path in a dark forest. It's spooky here.
```

### Links

Links are how players navigate between passages in your story. PyVN offers several types of links, from simple navigation to complex actions with delays.

#### Basic Links

The most common type of link simply takes the player from one passage to another when clicked.

**Syntax:** `[[Link Text->PassageName]]`

*   **`Link Text`**: The visible text that the player clicks.
*   **`PassageName`**: The name of the passage to navigate to.

**Example:**

```
:: Start
Welcome! Where would you like to go?
[[To the forest->ForestPath]]

:: ForestPath
You are on the forest path.
[[Go back->Start]]
```

#### Redirect Links

Redirect links allow you to specify a new passage to navigate to without needing to provide any text for the link. This is useful for use with the `#silent` tag where you want to execute some logic and then seamlessly transition to the next passage without player interaction.

**Syntax:** `[[->PassageName]]`

*   **`PassageName`**: The target passage to redirect to.

**Example:**

```
:: CheckCondition #silent
{% if player.health <= 0 %}
    [[->GameOver]]
{% else %}
    [[->ContinueAdventure]]
{% endif %}
```

When the `CheckCondition` passage is rendered, the engine will immediately redirect to either `GameOver` or `ContinueAdventure` based on the player's health.

#### Links with Actions

For dynamic interactions, you can embed a Jinja/Python script directly within a link. This script executes on the server when the link is clicked, *before* navigating to the target passage. This is powerful for updating game state directly from a player's choice.

**Syntax:** `[[Link Text->PassageName||{% Jinja Action %}]]`

*   **`Link Text`**: The text displayed for the link.
*   **`PassageName`**: The target passage to navigate to after the action.
*   **`{% Jinja Action %}`**: The Jinja/Python code to execute. This can be any valid Jinja statement that modifies the game state (e.g., `{% do set_flag('my_flag', True) %}`, `{% do player.gold = player.gold - 10 %}`).

**Example:**

```
:: Shop
You have {{ player.gold }} gold.
[[Buy Potion (10 gold)->Shop|| {% do player.gold = player.gold - 10 %}]]
[[Leave Shop->TownSquare|| {% do set_flag('in_shop', False) %}]]
```

When the player clicks "Buy Potion", their gold will be reduced by 10, and then they will be taken back to the `Shop` passage. When they click "Leave Shop", the `in_shop` flag will be set to `False`, and then they will navigate to `TownSquare`.

**Important:** The action script is executed on the server. It has full access to the global game state and helper functions (like `set_flag`, `set_variable`, `player`, `variables`, etc.).

### Passage Tags

You can assign one or more tags to a passage, which can be useful for styling, categorizing, or implementing game logic. To add tags, simply include them in the passage header, prefixed with a `#` symbol.

**Syntax:**

```
:: PassageName #tag1 #tag2 #another_tag
```

**Example:**

```
:: DarkCave #dark #danger #explore
You enter a dark cave. It's eerily quiet.
```

In this example, the passage "DarkCave" would have the tags `dark`, `danger`, and `explore` associated with it. These tags can then be used in your CSS (e.g., to apply specific styles to passages with the `dark` tag) or in your game logic (e.g., to check if the current passage has the `danger` tag).

#### Special Tags
##### The `#menu` Tag

Passages tagged with `#menu` are typically used for UI screens like inventory, character stats, or save/load menus. The engine treats these passages specially when tracking the `last_passage` variable. When you navigate *from* a `#menu` tagged passage, the `last_passage` variable is *not* updated. This ensures that `last_passage` always points to the last "gameplay" passage, making it easy to implement a "Back to Game" button.

**Example:**

```
:: Inventory #menu
Your inventory items...
[[Back to Game->{{ last_passage }}]]
```

##### The `#silent` Tag

Passages tagged with `#silent` are unique: they are never displayed to the player. Instead, when the engine navigates to a silent passage, it executes all its Python and Jinja logic, and then immediately redirects to the first link found within that passage. This happens entirely on the server, making it a powerful tool for invisible logic and conditional routing.

**Use Cases:**

*   **Invisible Logic:** Perform calculations, update game state, or trigger events without showing an intermediate screen.
*   **Conditional Routing:** Direct players to different passages based on game state (e.g., `[[->GoodEnding]]` or `[[->BadEnding]]` based on player choices).
*   **Random Events:** Determine the outcome of a random event and then send the player to the appropriate result passage.

**Example:**

```
:: CheckItem #silent
{% if has_item('key') %}
    [[->DoorUnlocked]]
{% else %}
    [[->DoorLocked]]
{% endif %}
```

### Special Passages

PyVN reserves three passage names for special functions:

- `:: NavMenu`: Content here is rendered as a persistent navigation menu. Ideal for global links like Inventory, Stats, or Save/Load.
- `:: PrePassage`: Content here is rendered _before_ every other passage. Useful for a persistent HUD or status display.
- `:: PostPassage`: Content here is rendered _after_ every other passage. Useful for footers.
- `:: start` : This passage is set as the starting passage by default. Can be changed by updating the `starting_passage` property in your `project.json` file.

### Text Formatting & HTML

You can use basic formatting syntax or embed raw HTML directly in your passages for full control over presentation.

- **Bold:** `**bold text**` or `<b>bold text</b>`
- **Italics:** `*italic text*` or `<i>italic text</i>`
- **Underline:** `<u>underline text</u>`
- **Line Breaks:** Use a blank line for a paragraph break, or `<br>` for a single line break.

**HTML Example:**

```
:: MyCustomPassage
<h1>Chapter 1</h1>
<p style="color: blue;">This is custom-styled text.</p>
<img src="/game/assets/my_image.png" alt="A beautiful scene">
```

### Dynamic Content with Jinja2

PyVN uses Jinja2 to render passages, allowing you to display variables and use logic based on the game's state.

- **Displaying Variables:** Use `{{ }}` to show data from the game state.
    
    ```
    :: Welcome
    Hello, {{ player.name }}! You have {{ player.health }} HP.
    ```
    
- **Conditional Logic:** Use `{% if %}` blocks to show content conditionally.
    
    ```
    :: CheckItem
    {% if has_item('key') %}
    You use the key to unlock the door.
    {% else %}
    The door is locked. You need a key.
    {% endif %}
    ```
    
- **Loops:** Use `{% for %}` to iterate over lists, like an inventory.
    
    ```
    :: Inventory
    Your items:
    <ul>
    {% for item in player.inventory %}
      <li>{{ item.name }} ({{ item.quantity }})</li>
    {% endfor %}
    </ul>
    ```
    

- **Accessing Game State:** Common variables like `player` (for player attributes like `name`, `health`, `inventory`), `flags`, `variables`, and `game_title` are directly available.
    *   **Note on Nested Data:** While direct access like `{{ variables.some_key }}` works for top-level keys, for deeply nested data (e.g., `variables = {'quest': {'main_quest': {'status': 'started'}}}`), you cannot use `{{ variables.quest.main_quest.status }}` directly. Instead, use dictionary-style access (`{{ variables['quest']['main_quest']['status'] }}`) or, more robustly, the `get_variable` helper function (`{{ get_variable('quest.main_quest.status', 'not_started') }}`). The `get_variable` function also allows you to specify a default value if the variable path does not exist, preventing errors.
    *   **Global vs. Local Variables:**
        *   To set or modify variables that persist throughout the game and are saved/loaded (part of the global game state), use Python helper functions like `set_variable('my_variable', value)` or `set_flag('my_flag', True)` within `{% do %}` or `{%- python %}` blocks.
        *   For temporary variables that are only needed for the current passage's rendering and do not persist, use Jinja2's `{% set my_local_variable = value %}`.

### User Input (`input_field`)

PyVN provides a convenient `input_field` macro to easily gather text or numerical input from the player and store it directly into your game state. This macro generates the necessary HTML form elements and uses HTMX for seamless, dynamic updates without full page reloads.

**Usage:**

```jinja
{{ input_field(variable_name, input_type='text', placeholder='', button_text='Submit', next_passage=None, **kwargs) | safe }}
```

*   **`variable_name`** (string, required): The name of the game state variable where the input value will be stored. Supports dot notation (e.g., `'player.name'`, `'variables.quest_log.entry_1'`).
*   **`input_type`** (string, optional): The HTML `type` attribute for the input field (e.g., `'text'`, `'number'`, `'password'`). Defaults to `'text'`.
*   **`placeholder`** (string, optional): Text displayed inside the input field when it's empty. Defaults to an empty string.
*   **`button_text`** (string, optional): The text displayed on the submit button. Defaults to `'Submit'`.
*   **`next_passage`** (string, optional): The name of the passage to advance to after the input is submitted. If omitted, the current passage will re-render.
*   **`**kwargs`**: Any additional HTML attributes you want to apply to the `<input>` tag (e.g., `class='my-input-style'`, `id='unique-id'`, `min='0'`, `max='100'`).

**Example:**

```jinja
:: CharacterCreation
What is your name, adventurer?
{{ input_field('player.name', placeholder='Your Name', button_text='Confirm Name') | safe }}

How old are you?
{{ input_field('player.age', input_type='number', placeholder='Age', class='age-input') | safe }}

Your name is: {{ player.name }}
Your age is: {{ player.age }}
```

When the player enters text and clicks the button, the value will be stored in the specified `variable_name` in the game state, and the current passage will automatically re-render to reflect the change (if you display the variable in the same passage).

> **Note:** Variables like `player` and functions like `has_item()` are part of the game state and logic system. See the [**Game Logic and State**](https://www.google.com/search?q=./04_Game_Logic_and_State.md "null") guide for a full reference.

### Python Code Blocks

For more complex logic directly within a passage, you can embed Python code using `{%- python %}` blocks. This code is executed when the passage is rendered and has access to the full game state.

```
:: DarkCave
You enter a dark cave. A chill runs down your spine.

{%- python %}
# This code runs when the player enters the DarkCave passage
import random
if random.randint(1, 10) > 7:
    set_flag('found_torch', True)
    add_to_inventory('torch', 1)
    debug("Player found a torch!")
{%- endpython %}

{% if get_flag('found_torch') %}
  <p class="success-text">You spot something glimmering and find a torch!</p>
{% endif %}
```